name: Playwright Browser Tests
run-name: ${{ github.workflow }} @ ${{ github.ref_name }}

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:
    branches: [master]
    types: [checks_requested]
  workflow_dispatch:

concurrency:
  # Only cancel in-progress runs if the branches are other than master
  # All commits pushed to master must be validated
    group: ${{ github.workflow }}-${{ github.ref_name == 'master' && github.run_id || github.event.pull_request.number || github.ref_name }}
    cancel-in-progress: true


permissions:
  contents: write

jobs:
  # build:
    # not needed
  test:
    name: Test
    # needs: build  # not needed
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    env:
      PLAYWRIGHT_SHARD: ${{ matrix.shard }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # - name: Download
      #   uses: actions/download-artifact@v4
      #   with: { name: build }

      - name: Cache
        uses: actions/cache@v4
        with:
          key: build${{ hashFiles('yarn.lock', '_03Typescript_Playwright/yarn.lock')}}
          restore-keys: |
            build${{ hashFiles('yarn.lock', '_03Typescript_Playwright/yarn.lock')}}
            build
          path: |
            ~/.m2/repository
            ~/.cache
            ~/.yarn

      # - name: Untar
      #   run: make unpackage-build

      # - name: Run
      #   run: make _03Typescript_Playwright

      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install Dependencies
        working-directory: _03Typescript_Playwright
        run: npm install

      - name: ğŸ“¦ Install Allure Playwright Reporter
        working-directory: _03Typescript_Playwright
        run: npm install --save-dev allure-playwright

      - name: ğŸ› ï¸ Install Playwright
        working-directory: _03Typescript_Playwright
        run: npx playwright install --with-deps

      - name: â–¶ï¸ Run Playwright Tests
        working-directory: _03Typescript_Playwright
        run: npx playwright test || true

      - name: Upload Report
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-blob-report-${{ matrix.shard }}
          path: playwright/blob-report/
          retention-days: 1

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: _03Typescript_Playwright/allure-results/
          retention-days: 1
        
  merge-reports:
    name: Merge-Reports
    if: success() || failure()
    needs: test
    runs-on: main

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Reports
        if: ${{ contains(join(needs.*.result, ','), 'failure')}}
        uses: actions/download-artifact@v4
        with:
          path: playwright/blob-report/
          pattern: playwright-blob-report-*
          merge-multiple: true

      - name: Download Alure Results
        uses: actions/download-artifact@v4
        with:
          path: _03Typescript_Playwright/allure-results/
          pattern: allure-results-*
          merge-multiple: true

      - name: Run
        if: ${{ contains(join(needs.*.result, ','), 'failure')}}
        run: make playwright-merge-reports

      - name: Upload Report
        if: ${{ contains(join(needs.*.result, ','), 'failure')}}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-attempt-${{ github.run_attempt }}
          path: _03Typescript_Playwright/playwright-report
          retention-days: 3

      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: allure-results
          path: ./_03Typescript_Playwright/allure-results/
          retention-days: 10

  generate-allure-report:
    env:
      ENVIRONMENT: inpostor
    
    defaults:
      run:
        working-directory: ./_03Typescript_Playwright
    if:
      success() || failure()
    needs: test
    runs-on: main

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install allure dep
        run: yarn
      
      - name: Download
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: ./_03Typescript_Playwright/allure-results/

      - name: Set timestamp
        id: time-stamp-id
        run: echo "timestamp=$(date --utc +%Y%m%d-%H%M%SZ)" >> "$GITHUB_OUTPUT"

      # - name: Generate, upload and write URL




      # âœ… DEBUG: VerificÄƒ dacÄƒ allure-results existÄƒ
      # - name: ğŸ•µï¸ Check if allure-results exists
      #   working-directory: ./_03Typescript_Playwright
      #   run: ls -R allure-results || echo "âš ï¸ Folderul allure-results NU existÄƒ!"

      # - name: ğŸ“Š Install and Generate Allure Report
      #   working-directory: ./_03Typescript_Playwright
      #   run: |
      #     npm install -g allure-commandline@2.24.0
      #     mkdir -p allure-report
      #     allure generate allure-results -o allure-report --clean || echo "âš ï¸ EROARE: Nu existÄƒ fiÈ™iere Ã®n allure-results!"

      # # âœ… DEBUG: VerificÄƒ dacÄƒ allure-report s-a generat corect
      # - name: ğŸ•µï¸ Debug Allure Report
      #   working-directory: ./_03Typescript_Playwright
      #   run: ls -R allure-report || echo "âš ï¸ Folderul allure-report este gol!"

      # - name: ğŸ•µï¸ Debug Paths Before Deploy
      #   working-directory: ./_03Typescript_Playwright
      #   run: |
      #     echo "ğŸ” PWD:" $(pwd)
      #     echo "ğŸ” HOME:" $HOME
      #     echo "ğŸ” List allure-report:"
      #     ls -la allure-report || echo "âš ï¸ Folderul allure-report NU existÄƒ!"

#      - name: ğŸ“‚ Ensure Publish Directory Exists
#        run: mkdir -p ${{ github.workspace }}/actions_github_pages
#
#      - name: ğŸšš Copy Allure Report for Deployment
#        run: |
#          mkdir -p actions_github_pages
#          cp -r _03Typescript_Playwright/allure-report/* ${{ github.workspace }}/actions_github_pages
#
#
#      - name: ğŸ“‚ Debug Publishing Directory  -----------
#        run: ls -la ${{ github.workspace }}/actions_github_pages || echo "âš ï¸ Folderul nu existÄƒ!"
#
#      - name: ğŸ“‚ VerificÄƒ ce fiÈ™iere sunt copiate
#        run: ls -la _03Typescript_Playwright/allure-report
#
#      - name: ğŸ“‚ VerificÄƒ conÈ›inutul final al folderului pentru deploy
#        run: ls -la /home/runner/work/UltimateLearningProject/UltimateLearningProject/actions_github_pages


      - name: ğŸš€ Deploy Allure Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.ACTIONS_ACCESS_TOKEN }}
          publish_dir: _03Typescript_Playwright/allure-report
          keep_files: true
          publish_branch: gh-pages

      - name: ğŸ”— Print Allure Report URL
        run: |
          echo "ğŸ”— Allure Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_id }}/"
